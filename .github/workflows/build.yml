name: Build AI Cleaner Cross Platform
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
jobs:
  build-macos:
    runs-on: macos-15-intel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.10.0
          pip install pandas==2.2.3
          pip install requests==2.32.3
          pip install openpyxl==3.1.5
      
      - name: Build macOS app
        run: |
          echo "ğŸ”„ æ„å»ºmacOSåº”ç”¨..."
          
          # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
          pyinstaller --onefile --windowed --name "AIæ¸…æ´—å·¥å…·2.0" mac_ai_cleaner.py
          
          # åˆ›å»ºappåŒ…ç»“æ„
          mkdir -p "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS"
          mkdir -p "AIæ¸…æ´—å·¥å…·2.0.app/Contents/Resources"
          cp dist/AIæ¸…æ´—å·¥å…·2.0 "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS/"
          
          # åˆ›å»ºInfo.plist
          cat > "AIæ¸…æ´—å·¥å…·2.0.app/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundleDisplayName</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundleVersion</key>
    <string>2.0.0</string>
    <key>CFBundleShortVersionString</key>
    <string>2.0.0</string>
    <key>CFBundleIdentifier</key>
    <string>com.ai.cleaner</string>
    <key>NSHumanReadableCopyright</key>
    <string>Â© 2024 AIæ¸…æ´—å·¥å…·</string>
    <key>CFBundleExecutable</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleSignature</key>
    <string>????</string>
    <key>LSArchitecturePriority</key>
    <array>
        <string>arm64</string>
        <string>x86_64</string>
    </array>
    <key>LSMinimumSystemVersion</key>
    <string>10.15.0</string>
</dict>
</plist>
EOF
          
          # è®¾ç½®æƒé™
          chmod -R 755 "AIæ¸…æ´—å·¥å…·2.0.app"
          chmod +x "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS/AIæ¸…æ´—å·¥å…·2.0"
          
          # ç§»é™¤éš”ç¦»å±æ€§
          xattr -cr "AIæ¸…æ´—å·¥å…·2.0.app"
          
          # æ·»åŠ ä¸´æ—¶ç­¾å
          codesign --force --deep --sign - "AIæ¸…æ´—å·¥å…·2.0.app"
          
          # éªŒè¯ç­¾å
          codesign -dvvv "AIæ¸…æ´—å·¥å…·2.0.app" 2>&1 | head -10
          
          echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Cleaner-macOS-App
          path: AIæ¸…æ´—å·¥å…·2.0.app
          retention-days: 90
  
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.10.0
          pip install pandas==2.2.3
          pip install requests==2.32.3
          pip install openpyxl==3.1.5
      
      - name: Build Windows executable
        run: pyinstaller --onefile --windowed --name "AIæ¸…æ´—å·¥å…·2.0-Windows" mac_ai_cleaner.py
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Cleaner-Windows-EXE
          path: dist/AIæ¸…æ´—å·¥å…·2.0-Windows.exe
          retention-days: 90
