name: Build AI Cleaner Cross Platform
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
jobs:
  build-macos:
    runs-on: macos-15-intel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.10.0
          pip install pandas==2.2.3
          pip install requests==2.32.3
          pip install openpyxl==3.1.5
      
      - name: Build macOS executable
        run: |
          echo "ğŸ”„ æ„å»ºmacOSå¯æ‰§è¡Œæ–‡ä»¶..."
          pyinstaller --onefile --windowed --name "AIæ¸…æ´—å·¥å…·2.0" mac_ai_cleaner.py
          echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Create macOS app bundle
        run: |
          echo "ğŸ”„ åˆ›å»ºmacOSåº”ç”¨åŒ…..."
          mkdir -p "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS"
          mkdir -p "AIæ¸…æ´—å·¥å…·2.0.app/Contents/Resources"
          cp dist/AIæ¸…æ´—å·¥å…·2.0 "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS/"
          
          # åˆ›å»ºInfo.plist
          cat > "AIæ¸…æ´—å·¥å…·2.0.app/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundleDisplayName</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundleVersion</key>
    <string>2.0.0</string>
    <key>CFBundleShortVersionString</key>
    <string>2.0.0</string>
    <key>CFBundleIdentifier</key>
    <string>com.ai.cleaner</string>
    <key>NSHumanReadableCopyright</key>
    <string>Â© 2024 AIæ¸…æ´—å·¥å…·</string>
    <key>CFBundleExecutable</key>
    <string>AIæ¸…æ´—å·¥å…·2.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleSignature</key>
    <string>????</string>
    <key>LSArchitecturePriority</key>
    <array>
        <string>arm64</string>
        <string>x86_64</string>
    </array>
</dict>
</plist>
EOF
          echo "âœ… åº”ç”¨åŒ…åˆ›å»ºå®Œæˆ"
      
      - name: Fix macOS app permissions and signature
        run: |
          echo "ğŸ”„ ä¿®å¤åº”ç”¨æƒé™å’Œç­¾å..."
          # ç§»é™¤æ‰€æœ‰æ‰©å±•å±æ€§ï¼ˆåŒ…æ‹¬éš”ç¦»å±æ€§ï¼‰
          xattr -cr "AIæ¸…æ´—å·¥å…·2.0.app"
          # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
          chmod -R 755 "AIæ¸…æ´—å·¥å…·2.0.app"
          # ä¸ºå¯æ‰§è¡Œæ–‡ä»¶è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x "AIæ¸…æ´—å·¥å…·2.0.app/Contents/MacOS/AIæ¸…æ´—å·¥å…·2.0"
          # æ·»åŠ ä¸´æ—¶ç­¾å
          codesign --force --deep --sign - "AIæ¸…æ´—å·¥å…·2.0.app"
          # éªŒè¯ç­¾å
          codesign -dvvv "AIæ¸…æ´—å·¥å…·2.0.app" 2>&1 | grep -E "(Authority|Identifier)" || true
          echo "âœ… åº”ç”¨æƒé™å’Œç­¾åä¿®å¤å®Œæˆ"
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Cleaner-macOS-App
          path: AIæ¸…æ´—å·¥å…·2.0.app
          retention-days: 90
  
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.10.0
          pip install pandas==2.2.3
          pip install requests==2.32.3
          pip install openpyxl==3.1.5
      
      - name: Build Windows executable
        run: |
          echo "ğŸ”„ æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶..."
          pyinstaller --onefile --windowed --name "AIæ¸…æ´—å·¥å…·2.0-Windows" mac_ai_cleaner.py
          echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Cleaner-Windows-EXE
          path: dist/AIæ¸…æ´—å·¥å…·2.0-Windows.exe
          retention-days: 90
