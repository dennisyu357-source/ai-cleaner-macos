name: Build AI Cleaner for macOS
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
jobs:
  build-macos:
    runs-on: macos-13
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: false
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==5.13.2 pandas==2.1.4 requests==2.31.0 openpyxl==3.1.2
    
    - name: Build executable
      run: pyinstaller --onefile --windowed --name "AI清洗工具2.0" mac_ai_cleaner.py
    
    - name: Create app bundle structure
      run: |
        mkdir -p "AI清洗工具2.0.app/Contents/MacOS"
        mkdir -p "AI清洗工具2.0.app/Contents/Resources"
        cp dist/AI清洗工具2.0 "AI清洗工具2.0.app/Contents/MacOS/"
    
    - name: Create minimal Info.plist
      run: |
        # 使用简单的命令创建Info.plist，避免YAML多行问题
        echo '<?xml version="1.0" encoding="UTF-8"?>' > "AI清洗工具2.0.app/Contents/Info.plist"
        echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "AI清洗工具2.0.app/Contents/Info.plist"
        echo '<plist version="1.0"><dict>' >> "AI清洗工具2.0.app/Contents/Info.plist"
        echo '<key>CFBundleName</key><string>AI清洗工具2.0</string>' >> "AI清洗工具2.0.app/Contents/Info.plist"
        echo '<key>CFBundleExecutable</key><string>AI清洗工具2.0</string>' >> "AI清洗工具2.0.app/Contents/Info.plist"
        echo '<key>CFBundlePackageType</key><string>APPL</string>' >> "AI清洗工具2.0.app/Contents/Info.plist"
        echo '</dict></plist>' >> "AI清洗工具2.0.app/Contents/Info.plist"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AI-Cleaner-macOS-App
        path: AI清洗工具2.0.app
        retention-days: 90
